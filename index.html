<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Layout Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: white;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 5px;
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }

        .room-info {
            background: #dbeafe;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            color: #1e40af;
        }

        .canvas-container {
            padding: 20px;
            text-align: center;
            overflow: auto;
        }

        #canvas {
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            touch-action: none;
            cursor: move;
        }

        .controls {
            background: white;
            padding: 15px;
            text-align: center;
            border-top: 1px solid #e5e7eb;
            display: none;
        }

        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        /* Keep Room Settings open as a side panel so the canvas stays visible/editable */
        #roomModal.active {
            align-items: flex-start;
            justify-content: flex-end;
            background: transparent;
            pointer-events: none;
            padding: 16px;
        }

        #roomModal .modal-content {
            width: min(420px, calc(100vw - 32px));
            max-width: 420px;
            border-radius: 12px;
            max-height: calc(100vh - 32px);
            pointer-events: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content h2 {
            font-size: 18px;
            margin-bottom: 15px;
        }

        .furniture-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .furniture-item {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
        }

        .furniture-item:hover {
            border-color: #3b82f6;
        }

        .furniture-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .furniture-size {
            font-size: 12px;
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 3px solid transparent;
            cursor: pointer;
        }

        .color-option.selected {
            border-color: #3b82f6;
        }

        .custom-btn {
            width: 100%;
            padding: 15px;
            border: 2px dashed #3b82f6;
            background: white;
            color: #3b82f6;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .notice {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            font-size: 13px;
        }

        .fixed-element-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fixed-element-info {
            flex: 1;
        }

        .fixed-element-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .fixed-element-details {
            font-size: 12px;
            color: #6b7280;
        }

        .fixed-element-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-left: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 0;
        }

        .saved-furniture-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Room Planner</h1>
        <div>
            <button class="btn btn-secondary" onclick="showRoomSettings()">Settings</button>
            <button class="btn btn-primary" onclick="saveLayout()">Save JSON</button>
            <button class="btn btn-primary" onclick="saveToLocalStorage(true)">Save Local</button>
            <button class="btn btn-primary" onclick="savePNG()">Save PNG</button>
            <button class="btn btn-success" onclick="document.getElementById('fileInput').click()">Open</button>
            <input type="file" id="fileInput" accept=".json" onchange="loadLayout(event)" class="hidden">
        </div>
    </div>

    <div class="room-info" id="roomInfo">Room Size: 575cm x 585cm</div>

    <div class="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <div class="controls" id="controls">
        <button class="btn btn-primary" onclick="rotateSelected()"> Rotate</button>
        <button class="btn btn-secondary" onclick="setSelectedPrice()">Price</button>
        <button class="btn btn-danger" onclick="deleteSelected()">Delete</button>
    </div>

    <button class="fab" onclick="showFurnitureMenu()">+</button>

    <!-- Furniture Menu -->
    <div id="furnitureModal" class="modal" onclick="hideFurnitureMenu()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Furniture</h2>
            <button class="custom-btn" onclick="showCustomForm()">+ Create Custom Furniture</button>
            <button class="btn btn-secondary" onclick="showManageFurniture()" style="width: 100%; margin-bottom: 15px;">Manage Saved Furniture</button>
            <div class="furniture-grid" id="furnitureGrid"></div>
        </div>
    </div>

    <!-- Manage Furniture Modal -->
    <div id="manageFurnitureModal" class="modal" onclick="hideManageFurniture()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Manage Saved Furniture</h2>
            <div id="savedFurnitureList"></div>
            <button class="btn btn-secondary" onclick="hideManageFurniture()" style="width: 100%; margin-top: 10px;">Close</button>
        </div>
    </div>

    <!-- Custom Furniture Form -->
    <div id="customModal" class="modal" onclick="hideCustomForm()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Create Custom Furniture</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="customName" placeholder="e.g., My Sofa">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Width (cm)</label>
                    <input type="number" id="customWidth" placeholder="120">
                </div>
                <div class="form-group">
                    <label>Depth (cm)</label>
                    <input type="number" id="customDepth" placeholder="60">
                </div>
            </div>
            <div class="form-group">
                <label>Price (JPY)</label>
                <input type="number" id="customPrice" placeholder="50000" min="0">
            </div>
            <div class="form-group">
                <label>Color</label>
                <div class="color-picker" id="colorPicker"></div>
            </div>
            <button class="btn btn-secondary" onclick="hideCustomForm()" style="width: 48%; margin-right: 4%;">Cancel</button>
            <button class="btn btn-primary" onclick="addCustomFurniture()" style="width: 48%;">Add</button>
        </div>
    </div>

    <!-- Room Settings -->
    <div id="roomModal" class="modal" onclick="hideRoomSettings()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Room Settings</h2>
            <div class="form-group">
                <label>Room Width (cm)</label>
                <input type="number" id="roomWidth" value="575">
            </div>
            <div class="form-group">
                <label>Room Height (cm)</label>
                <input type="number" id="roomHeight" value="585">
            </div>

            <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 16px;">Fixed Elements</h3>
            <div id="fixedElementsList"></div>
            <button class="custom-btn" onclick="addFixedElement()">+ Add Fixed Element</button>

            <div class="notice">
                Note: You can edit/delete fixed room elements, drag them on the canvas, or move them from the list with Select/L/U/D/R.
            </div>
            <button class="btn btn-secondary" onclick="hideRoomSettings()" style="width: 48%; margin-right: 4%;">Cancel</button>
            <button class="btn btn-primary" onclick="applyRoomSettings()" style="width: 48%;">Apply</button>
        </div>
    </div>

    <!-- Add Fixed Element Modal -->
    <div id="addFixedModal" class="modal" onclick="hideAddFixedModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Fixed Element</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="fixedName" placeholder="e.g., Window">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>X Position (cm)</label>
                    <input type="number" id="fixedX" placeholder="0">
                </div>
                <div class="form-group">
                    <label>Y Position (cm)</label>
                    <input type="number" id="fixedY" placeholder="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Width (cm)</label>
                    <input type="number" id="fixedW" placeholder="100">
                </div>
                <div class="form-group">
                    <label>Height (cm)</label>
                    <input type="number" id="fixedD" placeholder="10">
                </div>
            </div>
            <div class="form-group">
                <label>Color</label>
                <div class="color-picker" id="fixedColorPicker"></div>
            </div>
            <button class="btn btn-secondary" onclick="hideAddFixedModal()" style="width: 48%; margin-right: 4%;">Cancel</button>
            <button class="btn btn-primary" onclick="confirmAddFixedElement()" style="width: 48%;">Add</button>
        </div>
    </div>

    <script>
        console.log('Room Planner loading...');

        // State
        let roomWidth = 575;
        let roomHeight = 585;
        let items = [];
        let selectedId = null;
        let selectedFixedIndex = null;
        let draggedItem = null;
        let draggedFixed = null;
        let dragOffset = { x: 0, y: 0 };
        let fixedDragOffset = { x: 0, y: 0 };
        let selectedColor = '#E8F5E9';
        let selectedFixedColor = '#BDBDBD';
        let userFurniture = []; // User's saved custom furniture

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Furniture catalog
        const furniture = [
            { name: 'Bed', w: 195, d: 140, color: '#FFE4E1', price: 140000 },
            { name: 'Desk', w: 120, d: 60, color: '#E6F3FF', price: 0 },
            { name: 'Sofa', w: 179, d: 74.5, color: '#E8F5E9', price: 100000 },
            { name: 'TV Board', w: 180, d: 42, color: '#FFF9C4', price: 22500 },
            { name: 'Dining Table', w: 76, d: 76, color: '#FFE0B2', price: 120000 },
            { name: 'Rounge Chair', w: 64, d: 69, color: '#F3E5F5', price: 0 },
            { name: 'Refrigerator', w: 60, d: 50, color: '#E0E0E0', price: 0 },
            { name: 'Bookshelf', w: 120, d: 28, color: '#D7CCC8', price: 0 },
            { name: 'Side Board', w: 120, d: 42, color: '#CFD8DC', price: 0 },
            { name: 'Rug', w: 240, d: 170, color: '#FFEBEE', price: 0 },
            { name: 'Center Table', w: 76, d: 38, color: '#FFF3E0', price: 39600 },
            { name: 'Lamp', w: 42, d: 42, color: '#FFF9C4', price: 0 },
            { name: 'wagon', w: 43, d:42, color: "White", price: 0},
            { name: 'cabinet', w:119, d:40, color: "#D7CCC8", price: 0}
        ];

        // Fixed room elements
        let fixed = [
            { name: 'Bath Room', x: 0, y: 0, w: 180, d: 60, color: '#BDBDBD' },
            { name: 'Kitchen', x: 0, y: 60, w: 60, d: 165, color: '#90CAF9' },
            { name: 'Door', x: 180, y: 0, w: 80, d: 10, color: '#A1887F' },
            { name: 'Closet', x: 265, y: 0, w: 200, d: 10, color: '#BCAAA4' },
            { name: 'Wall', x: 175, y: 0, w: 5, d: 120, color: '#BCAAA4' },
            { name: 'Wall', x: 260, y: 0, w: 5, d: 80, color: '#BCAAA4' },
            { name: 'Window', x: 105, y: 575, w: 180*2, d: 10, color: '#BCAAA4' },
            { name: "Window", x: 565, y: 585-415-120, w: 10, d: 120, color: '#BCAAA4' }
        ];

        const colors = ['#FFE4E1', '#E6F3FF', '#E8F5E9', '#FFF9C4', '#FFE0B2', '#F3E5F5', '#E0E0E0', '#D7CCC8'];

        function normalizePrice(value) {
            const price = Number(value);
            return Number.isFinite(price) && price >= 0 ? Math.round(price) : 0;
        }

        function formatYen(value) {
            return new Intl.NumberFormat('ja-JP').format(normalizePrice(value));
        }

        function calculateTotalPrice() {
            return items.reduce((sum, item) => sum + normalizePrice(item.price), 0);
        }

        function updateRoomInfo() {
            document.getElementById('roomInfo').textContent =
                `Room Size: ${roomWidth}cm x ${roomHeight}cm | Total: JPY ${formatYen(calculateTotalPrice())}`;
        }

        function getLayoutData() {
            return {
                roomWidth,
                roomHeight,
                items,
                fixed,
                userFurniture
            };
        }

        function saveToLocalStorage(showMessage = false) {
            localStorage.setItem('roomPlannerData', JSON.stringify(getLayoutData()));
            if (showMessage) {
                alert('Layout saved to localStorage.');
            }
        }

        function autoSave() {
            saveToLocalStorage(false);
        }

        function loadAutoSave() {
            const saved = localStorage.getItem('roomPlannerData');
            if (!saved) return;

            let data;
            try {
                data = JSON.parse(saved);
            } catch (err) {
                console.warn('Failed to parse localStorage data:', err);
                localStorage.removeItem('roomPlannerData');
                return;
            }

            roomWidth = data.roomWidth || roomWidth;
            roomHeight = data.roomHeight || roomHeight;
            items = (data.items || []).map(item => ({ ...item, price: normalizePrice(item.price) }));
            fixed = data.fixed || [];
            userFurniture = (data.userFurniture || []).map(f => ({ ...f, price: normalizePrice(f.price) }));

            updateRoomInfo();
            populateFurnitureGrid();
        }

        // Initialize
        function init() {
            console.log('Initializing...');
            setCanvasSize();
            loadAutoSave();
            populateFurnitureGrid();
            populateColorPicker();
            draw();

            canvas.addEventListener('mousedown', onMouseDown);
            canvas.addEventListener('mousemove', onMouseMove);
            canvas.addEventListener('mouseup', onMouseUp);
            canvas.addEventListener('touchstart', onTouchStart, { passive: false });
            canvas.addEventListener('touchmove', onTouchMove, { passive: false });
            canvas.addEventListener('touchend', onTouchEnd);
            window.addEventListener('resize', () => {
                setCanvasSize();
                draw();
            });

            console.log('Initialized!');
        }

        function setCanvasSize() {
            const size = Math.min(window.innerWidth - 40, 600);
            canvas.width = size;
            canvas.height = size;
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
        }

        function populateFurnitureGrid() {
            const grid = document.getElementById('furnitureGrid');
            grid.innerHTML = '';

            // Add user's saved furniture first
            userFurniture.forEach(f => {
                const div = document.createElement('div');
                div.className = 'furniture-item';
                div.style.backgroundColor = f.color;
                div.innerHTML = `<div class="furniture-name">${f.name}</div><div class="furniture-size">${f.w} x ${f.d}cm</div><div class="furniture-size">JPY ${formatYen(f.price)}</div>`;
                div.onclick = () => addFurniture(f);
                grid.appendChild(div);
            });

            // Then add preset furniture
            furniture.forEach(f => {
                const div = document.createElement('div');
                div.className = 'furniture-item';
                div.style.backgroundColor = f.color;
                div.innerHTML = `<div class="furniture-name">${f.name}</div><div class="furniture-size">${f.w} x ${f.d}cm</div><div class="furniture-size">JPY ${formatYen(f.price)}</div>`;
                div.onclick = () => addFurniture(f);
                grid.appendChild(div);
            });
        }

        function populateColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = '';
            colors.forEach(c => {
                const div = document.createElement('div');
                div.className = 'color-option' + (c === selectedColor ? ' selected' : '');
                div.style.backgroundColor = c;
                div.onclick = () => {
                    selectedColor = c;
                    document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                };
                picker.appendChild(div);
            });
        }

        function draw() {
            const size = canvas.width;
            const scale = size / Math.max(roomWidth, roomHeight);
            updateRoomInfo();

            ctx.clearRect(0, 0, size, size);

            // Draw axes with measurements
            ctx.fillStyle = '#333';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';

            // X-axis labels (bottom)
            for (let i = 0; i <= roomWidth; i += 100) {
                const x = i * scale;
                ctx.fillText(i + 'cm', x, roomHeight * scale + 15);
                // Tick mark
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, roomHeight * scale);
                ctx.lineTo(x, roomHeight * scale + 5);
                ctx.stroke();
            }

            // Y-axis labels (left side)
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let i = 0; i <= roomHeight; i += 100) {
                const y = i * scale;
                ctx.fillText(i + 'cm', -5, y);
                // Tick mark
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(-5, y);
                ctx.stroke();
            }

            // Reset text alignment
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // Room outline
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, roomWidth * scale, roomHeight * scale);

            // Grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= roomWidth; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i * scale, 0);
                ctx.lineTo(i * scale, roomHeight * scale);
                ctx.stroke();
            }
            for (let i = 0; i <= roomHeight; i += 50) {
                ctx.beginPath();
                ctx.moveTo(0, i * scale);
                ctx.lineTo(roomWidth * scale, i * scale);
                ctx.stroke();
            }

            // Fixed elements
            fixed.forEach((f, idx) => {
                ctx.fillStyle = f.color;
                ctx.fillRect(f.x * scale, f.y * scale, f.w * scale, f.d * scale);
                ctx.strokeStyle = idx === selectedFixedIndex ? '#2563eb' : '#666';
                ctx.lineWidth = idx === selectedFixedIndex ? 3 : 1.5;
                ctx.strokeRect(f.x * scale, f.y * scale, f.w * scale, f.d * scale);
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(f.name, (f.x + f.w/2) * scale, (f.y + f.d/2) * scale);
            });

            // Furniture
            items.forEach(item => {
                ctx.globalAlpha = 0.9;
                ctx.fillStyle = item.color;
                ctx.fillRect(item.x * scale, item.y * scale, item.w * scale, item.d * scale);
                ctx.globalAlpha = 1;
                ctx.strokeStyle = item.id === selectedId ? '#2563eb' : '#333';
                ctx.lineWidth = item.id === selectedId ? 3 : 1.5;
                ctx.strokeRect(item.x * scale, item.y * scale, item.w * scale, item.d * scale);
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.fillText(item.name, (item.x + item.w/2) * scale, (item.y + item.d/2) * scale);
                ctx.font = '8px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText(`${item.w} x ${item.d}cm`, (item.x + item.w/2) * scale, (item.y + item.d/2 + 12) * scale);
                ctx.fillText(`JPY ${formatYen(item.price)}`, (item.x + item.w/2) * scale, (item.y + item.d/2 + 22) * scale);
            });
        }

        function getPos(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const scale = canvas.width / Math.max(roomWidth, roomHeight);
            return {
                x: (clientX - rect.left) / scale,
                y: (clientY - rect.top) / scale
            };
        }

        function findItem(x, y) {
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];
                if (x >= item.x && x <= item.x + item.w && y >= item.y && y <= item.y + item.d) {
                    return item;
                }
            }
            return null;
        }

        function findFixedElementIndex(x, y) {
            for (let i = fixed.length - 1; i >= 0; i--) {
                const f = fixed[i];
                if (x >= f.x && x <= f.x + f.w && y >= f.y && y <= f.y + f.d) {
                    return i;
                }
            }
            return -1;
        }

        function isRoomSettingsActive() {
            return document.getElementById('roomModal').classList.contains('active');
        }

        function onMouseDown(e) {
            const pos = getPos(e.clientX, e.clientY);
            if (isRoomSettingsActive()) {
                const fixedIndex = findFixedElementIndex(pos.x, pos.y);
                if (fixedIndex >= 0) {
                    selectedFixedIndex = fixedIndex;
                    selectedId = null;
                    draggedFixed = fixed[fixedIndex];
                    fixedDragOffset = { x: pos.x - draggedFixed.x, y: pos.y - draggedFixed.y };
                    document.getElementById('controls').style.display = 'none';
                    draw();
                    return;
                }
            }

            const item = findItem(pos.x, pos.y);
            if (item) {
                draggedItem = item;
                selectedId = item.id;
                selectedFixedIndex = null;
                dragOffset = { x: pos.x - item.x, y: pos.y - item.y };
                document.getElementById('controls').style.display = 'block';
                draw();
            }
        }

        function onMouseMove(e) {
            const pos = getPos(e.clientX, e.clientY);
            if (draggedItem) {
                draggedItem.x = Math.max(0, Math.min(roomWidth - draggedItem.w, pos.x - dragOffset.x));
                draggedItem.y = Math.max(0, Math.min(roomHeight - draggedItem.d, pos.y - dragOffset.y));
                draw();
                return;
            }
            if (draggedFixed) {
                draggedFixed.x = Math.max(0, Math.min(roomWidth - draggedFixed.w, pos.x - fixedDragOffset.x));
                draggedFixed.y = Math.max(0, Math.min(roomHeight - draggedFixed.d, pos.y - fixedDragOffset.y));
                if (isRoomSettingsActive()) {
                    populateFixedElementsList();
                }
                draw();
                return;
            }
            draw();
        }

        function onMouseUp() {
            if (draggedFixed && isRoomSettingsActive()) {
                populateFixedElementsList();
            }
            draggedItem = null;
            draggedFixed = null;
            autoSave();
        }

        function onTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const pos = getPos(touch.clientX, touch.clientY);
            if (isRoomSettingsActive()) {
                const fixedIndex = findFixedElementIndex(pos.x, pos.y);
                if (fixedIndex >= 0) {
                    selectedFixedIndex = fixedIndex;
                    selectedId = null;
                    draggedFixed = fixed[fixedIndex];
                    fixedDragOffset = { x: pos.x - draggedFixed.x, y: pos.y - draggedFixed.y };
                    document.getElementById('controls').style.display = 'none';
                    draw();
                    return;
                }
            }

            const item = findItem(pos.x, pos.y);
            if (item) {
                draggedItem = item;
                selectedId = item.id;
                selectedFixedIndex = null;
                dragOffset = { x: pos.x - item.x, y: pos.y - item.y };
                document.getElementById('controls').style.display = 'block';
                draw();
            }
        }

        function onTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const pos = getPos(touch.clientX, touch.clientY);
            if (draggedItem) {
                draggedItem.x = Math.max(0, Math.min(roomWidth - draggedItem.w, pos.x - dragOffset.x));
                draggedItem.y = Math.max(0, Math.min(roomHeight - draggedItem.d, pos.y - dragOffset.y));
                draw();
                return;
            }
            if (draggedFixed) {
                draggedFixed.x = Math.max(0, Math.min(roomWidth - draggedFixed.w, pos.x - fixedDragOffset.x));
                draggedFixed.y = Math.max(0, Math.min(roomHeight - draggedFixed.d, pos.y - fixedDragOffset.y));
                if (isRoomSettingsActive()) {
                    populateFixedElementsList();
                }
                draw();
                return;
            }
            draw();
        }

        function onTouchEnd() {
            if (draggedFixed && isRoomSettingsActive()) {
                populateFixedElementsList();
            }
            draggedItem = null;
            draggedFixed = null;
            autoSave();
        }

        function addFurniture(f) {
            items.push({
                id: Date.now(),
                name: f.name,
                x: 100,
                y: 100,
                w: f.w,
                d: f.d,
                color: f.color,
                price: normalizePrice(f.price)
            });
            hideFurnitureMenu();
            autoSave();
            draw();
        }

        function addCustomFurniture() {
            const name = document.getElementById('customName').value;
            const w = parseInt(document.getElementById('customWidth').value);
            const d = parseInt(document.getElementById('customDepth').value);
            const price = normalizePrice(document.getElementById('customPrice').value);

            if (!name || !w || !d) {
                alert('Please fill in all fields');
                return;
            }

            const newFurniture = {
                name: name,
                w: w,
                d: d,
                color: selectedColor,
                price: price
            };

            // Save to user's furniture library
            userFurniture.push(newFurniture);

            // Add to room
            items.push({
                id: Date.now(),
                name: name,
                x: 100,
                y: 100,
                w: w,
                d: d,
                color: selectedColor,
                price: price
            });

            document.getElementById('customName').value = '';
            document.getElementById('customWidth').value = '';
            document.getElementById('customDepth').value = '';
            document.getElementById('customPrice').value = '';
            hideCustomForm();
            hideFurnitureMenu();
            populateFurnitureGrid(); // Refresh grid
            autoSave();
            draw();
        }

        function setSelectedPrice() {
            const item = items.find(i => i.id === selectedId);
            if (!item) return;

            const input = prompt('Set furniture price (JPY)', String(normalizePrice(item.price)));
            if (input === null) return;

            const parsed = Number(input);
            if (!Number.isFinite(parsed) || parsed < 0) {
                alert('Please enter a valid non-negative number.');
                return;
            }

            item.price = Math.round(parsed);
            autoSave();
            draw();
        }

        function rotateSelected() {
            const item = items.find(i => i.id === selectedId);
            if (item) {
                [item.w, item.d] = [item.d, item.w];
                autoSave();
                draw();
            }
        }

        function deleteSelected() {
            items = items.filter(i => i.id !== selectedId);
            selectedId = null;
            document.getElementById('controls').style.display = 'none';
            autoSave();
            draw();
        }

        function showFurnitureMenu() {
            document.getElementById('furnitureModal').classList.add('active');
        }

        function hideFurnitureMenu() {
            document.getElementById('furnitureModal').classList.remove('active');
        }

        function showCustomForm() {
            document.getElementById('customModal').classList.add('active');
        }

        function hideCustomForm() {
            document.getElementById('customModal').classList.remove('active');
        }

        function showManageFurniture() {
            const list = document.getElementById('savedFurnitureList');
            list.innerHTML = '';

            if (userFurniture.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No saved furniture yet. Create custom furniture to save them!</p>';
            } else {
                userFurniture.forEach((f, idx) => {
                    const div = document.createElement('div');
                    div.className = 'saved-furniture-item';
                    div.style.backgroundColor = f.color;
                    div.innerHTML = `
                        <div>
                            <div class="furniture-name">${f.name}</div>
                            <div class="furniture-size">${f.w} x ${f.d}cm</div>
                            <div class="furniture-size">JPY ${formatYen(f.price)}</div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteSavedFurniture(${idx}); event.stopPropagation();">Delete</button>
                    `;
                    list.appendChild(div);
                });
            }

            document.getElementById('manageFurnitureModal').classList.add('active');
        }

        function hideManageFurniture() {
            document.getElementById('manageFurnitureModal').classList.remove('active');
        }

        function deleteSavedFurniture(index) {
            if (confirm('Delete this furniture from your saved list?')) {
                userFurniture.splice(index, 1);
                populateFurnitureGrid();
                autoSave();
                showManageFurniture(); // Refresh the list
            }
        }

        function populateFixedElementsList() {
            const list = document.getElementById('fixedElementsList');
            list.innerHTML = '';

            fixed.forEach((f, idx) => {
                const div = document.createElement('div');
                div.className = 'fixed-element-item';
                div.style.backgroundColor = f.color;
                if (idx === selectedFixedIndex) {
                    div.style.borderColor = '#2563eb';
                    div.style.boxShadow = '0 0 0 2px rgba(37, 99, 235, 0.2)';
                }
                div.innerHTML = `
                    <div class="fixed-element-info">
                        <div class="fixed-element-name">${f.name}</div>
                        <div class="fixed-element-details">Position: (${f.x}, ${f.y})cm, Size: ${f.w} x ${f.d}cm</div>
                    </div>
                    <div class="fixed-element-actions">
                        <button class="btn btn-secondary btn-small" onclick="selectFixedElement(${idx}); event.stopPropagation();">Select</button>
                        <button class="btn btn-secondary btn-small" onclick="nudgeFixedElement(${idx}, -10, 0); event.stopPropagation();">L</button>
                        <button class="btn btn-secondary btn-small" onclick="nudgeFixedElement(${idx}, 0, -10); event.stopPropagation();">U</button>
                        <button class="btn btn-secondary btn-small" onclick="nudgeFixedElement(${idx}, 0, 10); event.stopPropagation();">D</button>
                        <button class="btn btn-secondary btn-small" onclick="nudgeFixedElement(${idx}, 10, 0); event.stopPropagation();">R</button>
                        <button class="btn btn-danger btn-small" onclick="deleteFixedElement(${idx}); event.stopPropagation();">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function selectFixedElement(index) {
            if (!fixed[index]) return;
            selectedFixedIndex = index;
            selectedId = null;
            document.getElementById('controls').style.display = 'none';
            populateFixedElementsList();
            draw();
        }

        function nudgeFixedElement(index, dx, dy) {
            const target = fixed[index];
            if (!target) return;
            target.x = Math.max(0, Math.min(roomWidth - target.w, target.x + dx));
            target.y = Math.max(0, Math.min(roomHeight - target.d, target.y + dy));
            selectedFixedIndex = index;
            populateFixedElementsList();
            autoSave();
            draw();
        }

        function deleteFixedElement(index) {
            if (confirm('Delete this fixed element?')) {
                fixed.splice(index, 1);
                if (selectedFixedIndex === index) {
                    selectedFixedIndex = null;
                } else if (selectedFixedIndex !== null && selectedFixedIndex > index) {
                    selectedFixedIndex -= 1;
                }
                populateFixedElementsList();
                autoSave();
                draw();
            }
        }

        function addFixedElement() {
            document.getElementById('fixedName').value = '';
            document.getElementById('fixedX').value = '';
            document.getElementById('fixedY').value = '';
            document.getElementById('fixedW').value = '';
            document.getElementById('fixedD').value = '';
            populateFixedColorPicker();
            document.getElementById('addFixedModal').classList.add('active');
        }

        function hideAddFixedModal() {
            document.getElementById('addFixedModal').classList.remove('active');
        }

        function populateFixedColorPicker() {
            const picker = document.getElementById('fixedColorPicker');
            picker.innerHTML = '';
            colors.forEach(c => {
                const div = document.createElement('div');
                div.className = 'color-option' + (c === selectedFixedColor ? ' selected' : '');
                div.style.backgroundColor = c;
                div.onclick = () => {
                    selectedFixedColor = c;
                    document.querySelectorAll('#fixedColorPicker .color-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                };
                picker.appendChild(div);
            });
        }

        function confirmAddFixedElement() {
            const name = document.getElementById('fixedName').value;
            const x = parseInt(document.getElementById('fixedX').value);
            const y = parseInt(document.getElementById('fixedY').value);
            const w = parseInt(document.getElementById('fixedW').value);
            const d = parseInt(document.getElementById('fixedD').value);

            if (!name || isNaN(x) || isNaN(y) || !w || !d) {
                alert('Please fill in all fields');
                return;
            }

            fixed.push({ name, x, y, w, d, color: selectedFixedColor });
            hideAddFixedModal();
            populateFixedElementsList();
            autoSave();
            draw();
        }

        function showRoomSettings() {
            document.getElementById('roomWidth').value = roomWidth;
            document.getElementById('roomHeight').value = roomHeight;
            selectedFixedIndex = null;
            populateFixedElementsList();
            document.getElementById('roomModal').classList.add('active');
        }

        function hideRoomSettings() {
            document.getElementById('roomModal').classList.remove('active');
            selectedFixedIndex = null;
            draggedFixed = null;
            draw();
        }

        function applyRoomSettings() {
            roomWidth = parseInt(document.getElementById('roomWidth').value) || 575;
            roomHeight = parseInt(document.getElementById('roomHeight').value) || 585;
            updateRoomInfo();
            hideRoomSettings();
            autoSave();
            draw();
        }

        function savePNG() {
            // Create a temporary canvas with extra space for labels
            const tempCanvas = document.createElement('canvas');
            const size = 800; // Higher resolution for better quality
            const padding = 40; // Space for axis labels
            tempCanvas.width = size + padding;
            tempCanvas.height = size + padding;
            const tempCtx = tempCanvas.getContext('2d');

            // Fill white background
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // Translate to make room for axes
            tempCtx.translate(padding, 0);

            const scale = size / Math.max(roomWidth, roomHeight);

            // Draw axes with measurements
            tempCtx.fillStyle = '#333';
            tempCtx.font = '12px Arial';
            tempCtx.textAlign = 'center';

            // X-axis labels
            for (let i = 0; i <= roomWidth; i += 100) {
                const x = i * scale;
                tempCtx.fillText(i + 'cm', x, roomHeight * scale + 20);
                tempCtx.strokeStyle = '#666';
                tempCtx.lineWidth = 1;
                tempCtx.beginPath();
                tempCtx.moveTo(x, roomHeight * scale);
                tempCtx.lineTo(x, roomHeight * scale + 5);
                tempCtx.stroke();
            }

            // Y-axis labels
            tempCtx.textAlign = 'right';
            tempCtx.textBaseline = 'middle';
            for (let i = 0; i <= roomHeight; i += 100) {
                const y = i * scale;
                tempCtx.fillText(i + 'cm', -8, y);
                tempCtx.strokeStyle = '#666';
                tempCtx.lineWidth = 1;
                tempCtx.beginPath();
                tempCtx.moveTo(0, y);
                tempCtx.lineTo(-5, y);
                tempCtx.stroke();
            }

            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'middle';

            // Room outline
            tempCtx.strokeStyle = '#333';
            tempCtx.lineWidth = 2;
            tempCtx.strokeRect(0, 0, roomWidth * scale, roomHeight * scale);

            // Grid
            tempCtx.strokeStyle = '#e0e0e0';
            tempCtx.lineWidth = 0.5;
            for (let i = 0; i <= roomWidth; i += 50) {
                tempCtx.beginPath();
                tempCtx.moveTo(i * scale, 0);
                tempCtx.lineTo(i * scale, roomHeight * scale);
                tempCtx.stroke();
            }
            for (let i = 0; i <= roomHeight; i += 50) {
                tempCtx.beginPath();
                tempCtx.moveTo(0, i * scale);
                tempCtx.lineTo(roomWidth * scale, i * scale);
                tempCtx.stroke();
            }

            // Fixed elements
            fixed.forEach(f => {
                tempCtx.fillStyle = f.color;
                tempCtx.fillRect(f.x * scale, f.y * scale, f.w * scale, f.d * scale);
                tempCtx.strokeStyle = '#666';
                tempCtx.lineWidth = 2;
                tempCtx.strokeRect(f.x * scale, f.y * scale, f.w * scale, f.d * scale);
                tempCtx.fillStyle = '#333';
                tempCtx.font = '14px Arial';
                tempCtx.fillText(f.name, (f.x + f.w/2) * scale, (f.y + f.d/2) * scale);
            });

            // Furniture
            items.forEach(item => {
                tempCtx.globalAlpha = 0.9;
                tempCtx.fillStyle = item.color;
                tempCtx.fillRect(item.x * scale, item.y * scale, item.w * scale, item.d * scale);
                tempCtx.globalAlpha = 1;
                tempCtx.strokeStyle = '#333';
                tempCtx.lineWidth = 2;
                tempCtx.strokeRect(item.x * scale, item.y * scale, item.w * scale, item.d * scale);
                tempCtx.fillStyle = '#333';
                tempCtx.font = '14px Arial';
                tempCtx.fillText(item.name, (item.x + item.w/2) * scale, (item.y + item.d/2) * scale);
                tempCtx.font = '11px Arial';
                tempCtx.fillStyle = '#666';
                tempCtx.fillText(`${item.w} x ${item.d}cm`, (item.x + item.w/2) * scale, (item.y + item.d/2 + 15) * scale);
            });

            // Download
            tempCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'room-layout.png';
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        function saveLayout() {
            const data = JSON.stringify(getLayoutData(), null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'room-layout.json';
            a.click();
        }

        function loadLayout(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.roomWidth) roomWidth = data.roomWidth;
                    if (data.roomHeight) roomHeight = data.roomHeight;
                    if (data.items) items = data.items.map(item => ({ ...item, price: normalizePrice(item.price) }));
                    if (data.fixed) fixed = data.fixed;
                    if (data.userFurniture) userFurniture = data.userFurniture.map(f => ({ ...f, price: normalizePrice(f.price) }));
                    updateRoomInfo();
                    populateFurnitureGrid();
                    autoSave();
                    draw();
                } catch (err) {
                    alert('Failed to load layout: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // Start
        init();
    </script>
</body>
</html>
